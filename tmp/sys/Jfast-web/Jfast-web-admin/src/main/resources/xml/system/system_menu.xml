<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="system.menu">
    <!-- 获取角色菜单-->
    <select id="system.menu.getMenuByRoles" parameterType="java.util.List" resultType="Map">
        select * from system_menu where id in
        (
            select menu_id from system_role_menu where role_id in
            <choose>
                <when test="list != null and  list.size() > 0">
                    <foreach collection="list" item="id" open="(" close=")" separator="," >
                        #{id}
                    </foreach>
                </when>
                <otherwise>
                    ('')
                </otherwise>
            </choose>
        ) order by sort desc
    </select>

    <!-- 获取用户一级菜单 -->
    <select id="system.menu.list.findByUser" parameterType="map" resultType="map">
        select * from system_menu where id in
        (
             select menu_id from system_role_menu where role_id in (
             select role_id from system_admin_role where admin_id = #{userId})
        ) and parent_id = '0' and type in (0, 1)
    </select>

    <select id="system.menu.list.findByParentId" resultType="map">
      <include refid="system.menu.findByParent.common"/>
        order by sort desc
    </select>

    <sql id="system.menu.findByParent.common">
      select a.name as label, a.id as value, a.url, a.type, a.parent_id, a.permissions, a.icon, b.name as parent_name from system_menu a left join (select id, name from system_menu) b
       on a.parent_id = b.id where a.parent_id = #{parentId}
    </sql>

    <select id="system.menu.list.findByParentIdAndRoleId" resultType="map">
        <include refid="system.menu.findByParent.common"/> and a.id in (
           select menu_id from system_role_menu where role_id in
           (select role_id from system_admin_role where admin_id = #{adminId})
        ) order by sort desc
    </select>

    <select id="system.menu.list" resultType="map">
       select a.*, b.name as parent_name from system_menu a left join (select id, name from system_menu) b
       on a.parent_id = b.id order by sort desc
    </select>

    <select id="system.menu.findById" resultType="map">
        select * from system_menu where id = #{id}
    </select>

    <select id="system.menu.findByParentId" resultType="map">
        select * from system_menu where parent_id = #{parentId}
    </select>

    <insert id="system.menu.save" parameterType="map">
        insert into system_menu
        <foreach collection="params.keys" item="key" open="(" close=")" separator="," >
            ${key}
        </foreach>
        values
        <foreach collection="params.values"  item="value" open="(" close=")" separator=",">
            #{value}
        </foreach>
    </insert>

    <update id="system.menu.update" parameterType="map">
        update system_menu
        <foreach collection="params.keys" item="key" open="set" separator="," >
            ${key} = #{params[${key}]}
        </foreach>
        where id = #{params.id}
    </update>
</mapper>